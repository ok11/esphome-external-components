services:
  esphome:
    image: esphome/esphome:${ESPHOME_TAG}
    container_name: esphome-test
    volumes:
      - type: bind
        source: ../../esphome/components
        target: /config/external_components
        read_only: true
      - type: bind
        source: ./test_configs
        target: /config/test_configs
    ports:
      - "6052:6052"  # ESPHome web dashboard
      - "6053:6053"  # ESPHome API
    environment:
      - ESPHOME_DASHBOARD_USE_PING=true
      - ESPHOME_DASHBOARD_RELATIVE_URL=/
    command: dashboard /config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6052"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    networks:
      - esphome-test-net

networks:
  esphome-test-net:
    driver: bridge

# Start compilation by running ./test_runner.py (part of the ./run_tests.sh)
# or by entering "esphome compile /config/test_configs/climate_test.yaml" 
# in the container's interactive shell / terminal
